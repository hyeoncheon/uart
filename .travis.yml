language: go

go:
  - "1.9"
  - "1.10"

# sudo enabled, fully virtualized virtual machine required for mysql 5.7.
# https://docs.travis-ci.com/user/database-setup/#MySQL-5.7
# https://docs.travis-ci.com/user/reference/trusty/

dist: trusty
sudo: required

addons:
  apt:
    sources:
      - mysql-5.7-trusty
    package:
      - mysql-server
      - mysql-client

env:
  global:
    - GO_ENV=test
    - CC_TEST_REPORTER_ID=871aa7166cc89677d1839bca6a9213454dcc94344f8ef937f07360e255cb774c

before_install:
  - sudo mysql_upgrade --force
  - sudo service mysql restart
  - mysql --version
  - go get -u github.com/golang/dep/cmd/dep
    #- go get -u github.com/gobuffalo/buffalo/buffalo
    #- pushd $GOPATH/src/github.com/gobuffalo/buffalo
    #- git checkout v0.11.0 ; popd
    #- pushd $GOPATH/src/github.com/gobuffalo/pop
    #- git checkout v4.0.7 ; popd
    #- pwd
    #- go get github.com/mattn/anko
    #- go get github.com/gobuffalo/buffalo/buffalo
    #- go get GOPATH/src/github.com/gobuffalo/pop/soda
  - wget https://github.com/gobuffalo/buffalo/releases/download/v0.11.0/buffalo_0.11.0_linux_amd64.tar.gz
  - tar xvf buffalo_0.11.0_linux_amd64.tar.gz
  - mv buffalo-no-sqlite $GOPATH/bin/buffalo
  - ls -l $GOPATH/bin
  - ls -ld $GOPATH/src/*/*

install:
  - dep ensure
  - mkdir -p $TRAVIS_BUILD_DIR/public/assets
  - npm install --no-progress
  - sh ./scripts/keygen.sh
  - cp database.yml.travis database.yml

before_script:
  - go get -u github.com/mattn/goveralls
  - go get -u github.com/AlekSi/gocoverutil
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build

script:
  - buffalo build
  #
  - buffalo db create -e test
  - buffalo db migrate -e test
  - UART_HOME=`pwd` GO_ENV=test gocoverutil -coverprofile=c.out -ignore=./vendor/... test -covermode=count ./... && ./cc-test-reporter after-build --exit-code 0
  #
  - buffalo db drop -e test
  - buffalo db create -e test
  - buffalo db migrate -e test
  - UART_HOME=`pwd` goveralls -service=travis-ci

after_script: true

after_success:
  # for codecov.io
  - cp c.out coverage.txt
  - bash <(curl -s https://codecov.io/bash)

